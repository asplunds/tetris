var t=Object.defineProperty,e=Object.defineProperties,o=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,s=(e,o,n)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n,l=(t,e)=>{for(var o in e||(e={}))r.call(e,o)&&s(t,o,e[o]);if(n)for(var o of n(e))i.call(e,o)&&s(t,o,e[o]);return t},a=(t,n)=>e(t,o(n));class c{constructor(){this.orientation=0,this.legalRotations=[0,90,180,270],this.currentRotation=0,this.flashing=!1,this.flashSequence=0,this.stillFrameCount=0,this._rotations=0}rotate(t){this.stillFrameCount=20,this._rotations++;const e=this.legalRotations.indexOf(this.currentRotation)+t;this.currentRotation=this.legalRotations[e]?this.legalRotations[e]:1===t?0:270}get rotations(){return this._rotations}get tileMap(){return this.allRotations[this.currentRotation].map}get rotationPoint(){return this.allRotations[this.currentRotation].rotate}}class f extends c{constructor(){super(),this.color="#eefc32",this.allRotations={0:{map:[[1,1],[1,1]],rotate:[0,0]},90:{map:[[1,1],[1,1]],rotate:[0,0]},180:{map:[[1,1],[1,1]],rotate:[0,0]},270:{map:[[1,1],[1,1]],rotate:[0,0]}}}}class h extends c{constructor(){super(),this.color="#00c1cc",this.allRotations={0:{map:[[1,1,1,1],[0,0,0,0]],rotate:[-1,0]},90:{map:[[0,1],[0,1],[0,1],[0,1]],rotate:[2,0]},180:{map:[[0,0,0,0],[1,1,1,1]],rotate:[-1,0]},270:{map:[[1,0],[1,0],[1,0],[1,0]],rotate:[1,0]}}}}class u extends c{constructor(){super(),this.color="#0047c1",this.allRotations={0:{map:[[1,0,0],[1,1,1],[0,0,0]],rotate:[0,0]},90:{map:[[0,1,1],[0,1,0],[0,1,0]],rotate:[1,0]},180:{map:[[0,0,0],[1,1,1],[0,0,1]],rotate:[0,0]},270:{map:[[0,1,0],[0,1,0],[1,1,0]],rotate:[1,0]}}}}class p extends c{constructor(){super(),this.color="#fc9e32",this.allRotations={0:{map:[[0,0,1],[1,1,1],[0,0,0]],rotate:[2,0]},90:{map:[[0,1,0],[0,1,0],[0,1,1]],rotate:[1,0]},180:{map:[[0,0,0],[1,1,1],[1,0,0]],rotate:[0,0]},270:{map:[[1,1,0],[0,1,0],[0,1,0]],rotate:[0,0]}}}}class d extends c{constructor(){super(),this.color="#0cd313",this.allRotations={0:{map:[[0,1,1],[1,1,0],[0,0,0]],rotate:[1,0]},90:{map:[[0,1,0],[0,1,1],[0,0,1]],rotate:[1,0]},180:{map:[[0,0,0],[0,1,1],[1,1,0]],rotate:[1,1]},270:{map:[[1,0,0],[1,1,0],[0,1,0]],rotate:[0,-1]}}}}class g extends c{constructor(){super(),this.color="#8d30ff",this.allRotations={0:{map:[[0,1,0],[1,1,1],[0,0,0]],rotate:[1,0]},90:{map:[[0,1,0],[0,1,1],[0,1,0]],rotate:[1,0]},180:{map:[[0,0,0],[1,1,1],[0,1,0]],rotate:[0,0]},270:{map:[[0,1,0],[1,1,0],[0,1,0]],rotate:[1,0]}}}}class m extends c{constructor(){super(),this.color="#ff303e",this.allRotations={0:{map:[[1,1,0],[0,1,1],[0,0,0]],rotate:[0,0]},90:{map:[[0,0,1],[0,1,1],[0,1,0]],rotate:[2,0]},180:{map:[[0,0,0],[1,1,0],[0,1,1]],rotate:[0,1]},270:{map:[[0,1,0],[1,1,0],[1,0,0]],rotate:[1,-1]}}}}function w(t){const e=t.height;return t.width,t=>{const o=[];for(let r=0;r<e;r++)for(const[e,n]of t[r].entries())n.instance?o.push([e,r,n]):"pink"!==n.color&&M&&(n.color=void 0),n.ghost=!1;const n=[];t:for(let r=0;r<e;r++){const e=[];for(const[n,i,s]of o){if(!t[i+r]||!t[i+r][n]||t[i+r][n].occupied)break t;e.push([n,i+r])}e.length===o.length&&n.push(e)}for(const[e,r]of n[n.length-1])t[r][e].ghost=!0;return t}}function y(t){t.height;const e=t.width,o=w(t);return(t,n)=>{const r=n.tileMap,i=r.length,s=r[0].length,l=Math.ceil(e/2)-Math.floor(s/2);for(let e=0;e<i;e++)for(const[o,i]of r[e].entries())i&&(t[e][o+l].instance=n);return o(t)}}const x=(t,e,o,n=!1)=>Math.random()<.05&&!n&&M?{occupied:!0,index:t,color:"pink",instance:void 0,x:e,y:o}:{occupied:!1,index:t,instance:void 0,x:e,y:o};const R=t=>t.replace(/px|em|rem|ch|%/,""),b=t=>{for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t},S=(t,e,o)=>{const n="#444",r={width:t.getAttribute("width"),height:t.getAttribute("height")},i=o.height,s=parseFloat(R(r.width)),l=parseFloat(R(r.height)),a=o.width,c=s-1*(a-1),f=~~(c/a),h=~~((c-f*a)/2),u=~~((l-1*(i-1)-f*i)/2);return t=>{e.fillStyle="transparent",e.clearRect(0,0,s,l);for(let o=0;o<i;o++)for(const[r,{instance:i,color:s,ghost:l}]of t[o].entries()){if(i)i.flashing?(i.flashSequence++,i.stillFrameCount++,i.flashSequence>50&&(i.flashSequence=-100),i.flashSequence<0?e.fillStyle="#fff":e.fillStyle=i.color):(i.flashSequence=0,e.fillStyle=i.color);else if(s)e.fillStyle=s;else{if(l){const t=2;e.fillStyle="#fff",e.fillRect(h+f*r+1*r,u+f*o+1*o,f,f),e.fillStyle=n,e.fillRect(h+f*r+1*r+t,u+f*o+1*o+t,f-2*t,f-2*t);continue}e.fillStyle=n}e.fillRect(h+f*r+1*r,u+f*o+1*o,f,f)}}},k=t=>{const e=t.height;t.width;const o=w(t);return t=>{const n=[];let r;t:for(let o=0;o<e;o++)for(const[e,i]of t[o].entries())if(i.instance){if(r||(r=i.instance),n.push([e,o,i]),n.length===i.instance.tileMap.flat().filter((t=>t)).length)break t}else"pink"!==i.color&&M&&(i.color=void 0);for(const[e,o,p]of n)t[o][e]=x(p.index,e,o,!0);const[i,s]=n[0],{rotationPoint:[l,a]}=r;r.rotate(1);const{tileMap:c}=r,f=c.reduce(((t,e)=>t+e.filter((t=>t)).length),0),h=[],u=((t,e=0)=>Array(t).fill(0).map(((t,o)=>[e-o,e+o])).flat())(f-1);t:for(const e of u)for(const o of u){const n=[];for(let r=0;r<c.length;r++)for(const[f,h]of c[r].entries()){const[c,u]=[i+f-l+o,s+r-a+e];h&&t[u]&&t[u][c]&&!t[u][c].occupied&&n.push(t[u][c])}if(n.length===f){h.push(n);break t}}if(h.length)for(const{x:e,y:o}of h[0])t[o][e]=n.pop()[2];else{r.rotate(-1);for(const[e,o,r]of n)t[o][e]=r}return t=o(t)}};const v=document.getElementById("game"),C=v.getContext("2d"),M=!1;!function(t,e,o){const n=[h,f,u,p,d,g,m];let r=b(n.slice(0));const i=()=>(r.length||(r=b(n.slice(0))),r.pop()),s=k(o),c=function(t,e){const o=t.height;t.width;const n=w(t),r=y(t);return(t,i,s)=>{const c=[],f=t.flat().find((t=>t.instance)),h=f&&f.instance;if(h&&(h.flashing&&h.rotations>12||h.stillFrameCount>250)){for(let e=0;e<o;e++)for(const[o,n]of t[e].entries())n.instance&&(t[e][o]=a(l({},n),{instance:void 0,color:h.color,occupied:!0}));return r(t,new(e()))}t:for(let e=o-1;e>=0;e--){const n=o-1-e;for(const[e,o]of t[n].entries())if(o.instance&&t[n+s]&&t[n+s][e+i]){const r=t[n+s][e+i];if(!r||r.occupied)return 1===s&&(h.flashing=!0),t;if(c.push([e,n,o]),c.length===o.instance.tileMap.flat().filter((t=>t)).length)break t}else if(o.instance&&(!t[n+s]||!t[n+s][e+i]))return 1===s&&(h.flashing=!0),t}h.flashing=!1,h.stillFrameCount=0;for(const[e,o,n]of c)t[o][e]=x(n.index,e,o,!0);for(const[e,o,n]of c)t[o+s][e+i]=a(l({},n),{index:t[o+s][e+i].index});return n(t)}}(o,i),R=y(o),v=((t,e)=>()=>{const{innerHeight:o}=window,{height:n,width:r}=e,i=r/n;t.setAttribute("height",~~(.8*o)+"px"),t.setAttribute("width",~~(.8*o*i)+"px")})(t,o),C=(t=>{const e=t.height;t.width;const o=w(t);return t=>{t=o(t);let n=null;const r=[],i=[];for(let o=0;o<e;o++)for(const[e,s]of t[o].entries())s.instance&&(n||(n=s.instance),r.push([e,o,s])),s.ghost&&i.push([e,o,s]);for(const[e,[o,s]]of r.entries()){const[r,c]=i[e];t[c][r]=a(l({},t[s][o]),{instance:void 0,color:n.color,occupied:!0})}for(const[e,o,s]of r)t[o][e].occupied||(t[o][e]=x(s.index,e,o));return t}})(o),M=function(t){const e=t.height;return t.width,t=>{for(let o=e-1;o>=0;o--)if(t[o].every((t=>t.occupied))){const e=[];for(const[n,{index:r}]of t[o].entries())t[o][n]=x(r,n,o,!0);for(let n=o;n>=0;n--)for(const[o,r]of t[n].entries())r.occupied&&e.push([o,n,r]);for(const[o,n,{index:r}]of e)t[n][o]=x(r,o,n,!0);for(const[o,n,r]of e)t[n+1][o]=a(l({},r),{y:n+1,index:t[n+1][o].index});o++}return t}}(o);v();let O=S(t,e,o),A=(t=>{const{height:e,width:o}=t;let n=0;return new Array(e).fill(0).map(((t,e)=>new Array(o).fill(0).map(((t,o)=>x(++n,o,e)))))})(o),F=null,q=null,P=null;A=R(A,new(i()));let j=null;window.addEventListener("keydown",(t=>{const e=t.which||t.keyCode;t.isComposing||229===t.keyCode||e===F||(F=e,32===e?(A=C(A),A=R(A,new(i())),A=M(A),F=null):38===e?A=s(A):(A=_(A,e),q=e,j&&clearTimeout(j),j=window.setTimeout((()=>{q===e&&(L=2,P=e)}),150)))})),window.addEventListener("keyup",(t=>{const e=t.which||t.keyCode;32===e||F===e&&(F=null),e!==P&&e!==q||38===e||(F=null,window.requestAnimationFrame((()=>{P=null,q=null})),P=null,q=null)}));let E=0,L=0;const T=()=>{O(A),2===L?(A=_(A,P),L=0):L++,35===E?(A=c(A,0,1),E=0):E++,setTimeout((()=>{window.requestAnimationFrame(T)}),1e3/60)};T();const _=(t,e)=>{switch(e){case 39:t=c(t,1,0);break;case 37:t=c(t,-1,0);break;case 40:t=c(t,0,1)}return t};window.addEventListener("resize",(()=>{v(),O=S(t,e,o)}))}(v,C,{height:20,width:10});
